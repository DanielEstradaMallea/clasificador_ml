name: MLOps Security Pipeline

# Se ejecuta cada vez que haces push a la rama principal
on:
  push:
    branches: [ "main" ]
  pull_request:
    branches: [ "main" ]

jobs:
  test-model-quality:
    runs-on: ubuntu-latest

    steps:
    # 1. Descargar tu código del repositorio
    - name: Checkout Code
      uses: actions/checkout@v3

    # 2. Instalar Python
    - name: Set up Python 3.10
      uses: actions/setup-python@v4
      with:
        python-version: '3.10'

    # 3. Instalar librerías
    - name: Install Dependencies
      run: |
        python -m pip install --upgrade pip
        pip install -r requirements.txt
        pip install pytest requests

    # 4. Levantar la API en segundo plano (Background)
    # Esto simula el servidor de producción dentro de GitHub
    - name: Start Flask API
      env:
        HF_TOKEN: ${{ secrets.HF_TOKEN }} # Lee el token si el repo es privado
      run: |
        # Ejecutar en background (&) y guardar logs
        nohup python app.py > server.log 2>&1 &
        echo "Servidor iniciado en segundo plano..."

    # 5. Ejecutar la batería de pruebas
    # El script test_api.py se encargará de esperar a que cargue el modelo
    - name: Run Integration Tests
      run: python test_api.py

    # 6. (Opcional) Mostrar logs del servidor si algo falló
    - name: Show Server Logs (on failure)
      if: failure()
      run: cat server.log